kind: pipeline
type: docker
name: default

trigger:
  event:
    - push
    - custom
  branch:
    - main

steps:
  - name: build-and-push-web
    image: plugins/docker
    settings:
      registry: "192.168.50.200:5000"
      repo:     "192.168.50.200:5000/rimtes-web"
      insecure: true
      context:  "."
      dockerfile: "dockerfile"
      tags:
        - ${DRONE_COMMIT_SHA}
        - latest

  - name: build-and-push-smtp
    image: plugins/docker
    settings:
      registry: "192.168.50.200:5000"
      repo:     "192.168.50.200:5000/rimtes-smtp"
      insecure: true
      context:  "smtp"
      dockerfile: "smtp/dockerfile"
      tags:
        - ${DRONE_COMMIT_SHA}
        - latest

  - name: deploy
    image: appleboy/drone-ssh
    settings:
      host:
        from_secret: SSH_HOST
      port:
        from_secret: SSH_PORT
      user: root
      key:
        from_secret: SSH_DEPLOY_KEY

    environment:
      EMAIL_USER:
        from_secret: EMAIL_USER
      EMAIL_PASS:
        from_secret: EMAIL_PASS

    script:
      - set -ex
      - docker pull 192.168.50.200:5000/rimtes-web:${DRONE_COMMIT_SHA}
      - docker pull 192.168.50.200:5000/rimtes-smtp:${DRONE_COMMIT_SHA}

      - docker rm -f rimtes-web rimtes-smtp || true

      - docker run -d --name rimtes-web \
          --restart=always              \
          -p 3004:80                    \
          192.168.50.200:5000/rimtes-web:${DRONE_COMMIT_SHA}

      - docker run -d --name rimtes-smtp \
          --restart=always              \
          -p 3005:3000                  \
          -e EMAIL_USER=${EMAIL_USER}   \
          -e EMAIL_PASS=${EMAIL_PASS}   \
          192.168.50.200:5000/rimtes-smtp:${DRONE_COMMIT_SHA}

      - docker ps --filter name=rimtes --format '{{.Names}}\t{{.Image}}\t{{.Status}}'

